<!DOCTYPE html>
<html lang="en">

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/addons/p5.sound.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta charset="utf-8" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    canvas {
      display: block;
    }
  </style>
</head>

<body>
  <main>
  </main>
  <script>

    class Drop {
      constructor(x, y, r, col) {
        this.center = createVector(x, y);
        this.r = r;
        this.circleDetail = 200;//this.r * 16;
        this.vertices = [];
        for (let i = 0; i < this.circleDetail; i++) {
          let angle = map(i, 0, this.circleDetail, 0, TWO_PI);
          let v = createVector(cos(angle), sin(angle));
          v.mult(this.r);
          v.add(this.center);
          this.vertices[i] = v;
        }
        this.col = col;
      }


      tine(m, x, y, z, c) {
        let u = 1 / pow(2, 1 / c);
        let b = createVector(x, y);
        for (let v of this.vertices) {
          let pb = p5.Vector.sub(v, b);
          let n = m.copy().rotate(HALF_PI);
          let d = abs(pb.dot(n));
          let mag = z * pow(u, d);
          v.add(m.copy().mult(mag));
        }
      }

      marble(other) {
        for (let v of this.vertices) {
          let c = other.center;
          let r = other.r;
          let p = v.copy();
          p.sub(c);
          let m = p.mag();
          let root = sqrt(1 + (r * r) / (m * m));
          p.mult(root);
          p.add(c);
          v.set(p);
        }
      }

      show() {
        fill(this.col);
        noStroke();
        beginShape();
        for (let v of this.vertices) {
          vertex(v.x, v.y);
        }
        endShape(CLOSE);
      }
    }

  </script>
  <script>
    let drops = [];

    let r = 1;
    let a = 0;

    let palette;
    let bk;

    let newDrop = true;
    let currentColor;

    function setup() {
      createCanvas(640, 360);
      palette = [
        color(11, 106, 136),
        color(45, 197, 244),
        color(112, 50, 126),
        color(146, 83, 161),
        color(164, 41, 99),
        color(236, 1, 90),
        color(240, 99, 164),
        color(241, 97, 100),
        color(248, 158, 79),
        //
      ];
      bk = color(252, 238, 33); //random(palette);
      currentColor = random(palette);
    }

    function tineLine(v, x, y, z, c) {
      for (let drop of drops) {
        drop.tine(v, x, y, z, c);
      }
    }

    function addInk(x, y, r, col) {
      let drop = new Drop(x, y, r, col);
      for (let other of drops) {
        other.marble(drop);
      }
      drops.push(drop);
    }

    function mouseReleased() {
      newDrop = true;
    }

    let val = 4;
    let counter = 1;

    function draw() {
      // if (mouseIsPressed) {
      //   let v1 = createVector(pmouseX, pmouseY);
      //   let v2 = createVector(mouseX, mouseY);
      //   v2.sub(v1);
      //   if (v2.mag() > 0.1) {
      //     v2.normalize();
      //     tineLine(v2, mouseX, mouseY, 2, 16);
      //   }
      // }

      if (mouseIsPressed) {
        if (newDrop) {
          currentColor = palette[counter % palette.length];
          newDrop = false;
          counter++;
        }
        addInk(mouseX, mouseY, 12, currentColor);
      }

      background(bk);
      for (let drop of drops) {
        drop.show();
      }
    }

  </script>
</body>

</html>